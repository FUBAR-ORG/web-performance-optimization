# `CDN`

## `CDN`을 사용하는 이유

- `CDN`: 웹 캐시 서버들을 전 세계에 분산 배치하고 원본 서버의 콘텐츠들을 웹 캐시 서버에 캐시해 사용자들에게 서비스함으로써 사용자 기기나 브라우저가 웹 콘텐츠를 보다 빠르게 다운로드할 수 있도록 하는 기술.
- 애플리케이션 서비스를 제공할 때 서버 용량 및 해외 사용자 로딩 속도를 위해 고려해야 할 상황
  - 서버 용량은 서비스 가용성 및 안정성에 큰 영향을 미침.
  1. 기존 서버의 용량을 증설
     - 하드웨어 및 소프트웨어 용량을 모두 늘려야 함.
     - 기존 애플리케이션 아키텍쳐를 크게 변경하지 않아도 되는 장점.
     - 원본 데이터 센터와 해외 사용자들 간 지리적 위치가 멀다면 로딩 속도를 보장할 수 없음.
  2. 해외에 직접 데이터 센터를 구축
     - 막대한 예산을 투입해야 함.
       - 투자 대비 수익을 보장하려면 철저한 시장 조사와 수요 예측이 필요.
     - 애플리케이션과 동기화하려면 복잡한 아키텍쳐를 설계해야 함.
  3. 해외에 있는 호스팅 서비스를 이용
     - 직접 데이터 센터를 설립하는 데 비해 훨씬 많은 비용 절감 가능.
     - 원본 애플리케이션의 수정, 테스트 및 배포에 대한 계획을 꼼꼼하게 세워야 하며 동기화 이슈도 여전함.
- `CDN` 서비스의 이점
  1. 성능 및 안정성 보장
     - `CDN` 서비스 업체들은 일반 호스팅 업체에 비해 많은 수의 Point Of Presence(`POP`)를 보유하고 있음.
     - `POP`은 웹 애플리케이션을 완벽히 수행하는 것보다 데이터를 캐시하는 데 목적을 둠.
       - 호스팅 업체처럼 복잡한 컴퓨팅을 보장하는 고사양 하드웨어가 필요하지 않음.
     - `POP`가 많을수록 인터넷 병목 구간을 피할 수 있어 캐시된 콘텐츠를 더 많은 사용자에게 빠르게 전송 가능.
     - `POP`간 `failover` 기능이 있기 때문에, 몇 개의 `POP`이 장애로 정지되어도 다른 `POP`에서 서비스할 수 있어 끈김 없이 서비스 제공 가능.
  2. 아키텍처 단순화
     - 원본 애플리케이션을 재배포하는 방식이 아니므로 애플리케이션 수정이나 동기화 방안 등을 고려하지 않아도 됨.
  3. 높은 비즈니스 투자 수익
     - 데이터 센터를 새로 만들지 않아도 글로벌 시장에 디지털 서비스를 쉽게 제공 가능.
     - 원가가 저렴해 투자 대비 효율성이 높음.
     - 서비스 시작 후 운영에 하드웨어나 네트워크 유지 보수를 위한 별도의 비용이 필요하지 않음.
     - 언제든 `CDN` 사용을 중지할 수 있어 융통성 있게 시스템 운영 가능.
     - 빠른 응답 속도로 사용자의 만족도를 향상시켜 매출 증가로 연결.
- `CDN`의 특징
  1. 동적 콘텐츠 가속
     - 애플리케이션 전송 네트워크(Application Delivery Network, `ADN`): 정적 리소스 전송을 넘어 개인화, 모바일 앱 서비스 등을 위한 동적 리소스 전송
     - 동적 콘텐츠 가속의 핵심은 네트워크 혼잡 구간을 어떻게 회피하느냐에 있음.
       - 기존 `CDN` 제공자들은 이 문제 해결을 위해 더 많은 `ISP` 업체와 파트너십을 강화, 전체 네트워크 구간을 모니터링해 고유의 알고리즘을 최적 경로를 선택하는 등 다양한 방식을 사용.
     - 모든 사물이 네트워크를 통해 연결되고 있고, 많은 데이터들이 더욱 안정적이고 빠르게 전송되어야 하므로 `ADN`은 앞으로 중요해질 것.
  2. 프론트엔드 최적화
     - `CDN` 제공자들은 프론트엔드 분석 툴 등의 최적화 모범 사례들을 에지 서버 상에서 자동화.
     - 원본 서버에서 최적화를 구현하지 않아도 손쉽게 웹 사이트의 로딩 속도를 향상시킬 수 있는 방안을 제공.
     - 빠른 시간 안에 웹 사이트의 속도를 향상시킬 필요가 있거나 프로모션 등으로 특정 페이지를 일정 기간 가속시킬 필요, 또는 개선해야 할 페이지가 많아 작업이 어렵다면 권장.
  3. 동영상 또는 라이브 스트리밍 서비스
     - `CDN`의 `VOD`(Video On Demand) 서비스를 이용하면 동영상을 수월하게 제공 가능.
     - 실시간 라이브 스트리밍 또한 `CDN`의 주요 서비스.
     - `CDN` 제공자들은 `HTTP` 프로토콜 기반에 스트리밍 영상을 전송할 수 있는 `HLS`, `HDS`, `MPEG-DASH` 같은 기술 프로토콜을 지원.
     - 플레이어와 연동하여 사용자의 네트워크 품질에 따라 영상의 비트 전송율을 조정함으로써 어디서든 끊김 없이 엿앙을 즐길 수 있도록 지원.
  4. 클라우드 보안
     - 기업의 데이터 센터에 `DDoS`나 악의적 공격들이 가해질 때 보안 장비가 모든 공격을 힘들게 차단하기보다 사용자와 인터넷의 접점에 위치한 `CDN`의 에지 서버들이 개별 공격을 선제 차단하는 것이 비용 효율적.
     - 대형 `CDN` 업체들은 이러한 기업들의 요구에 맞춰 보안 분야까지 사업 영역을 확대하고 `DDoS` 방어 서비스, 웹 애플리케이션 방화벽(`WAF`) 서비스 등을 제공.
- 대표적인 `CDN` 업체
  - `Akamai Technologies`
  - `CDNetwoks`
  - `Amazon CloudFront`
  - `Limelight Networks`
  - `Microsoft Azure`
  - `Cloudflare`

---

## `CDN`의 원리

- `CDN` 업체들은 대부분 사용자 스스로 `CDN` 설정을 수정하고 관리하도록 권장.
- `CDN`의 기본 아키텍처와 동작 원리를 잘 이해한다면 스스로 `CDN`을 설정하고 관리하는 데 큰 도움이 될 것.
- 불필요한 인프라에 대한 투자를 줄이고 더 효율적으로 성능 향상 가능.

### `CDN` 서비스 아키텍처

- `CDN` 서비스는 콘텐츠를 제공하는 원본 서버와 실제 인터넷을 통해 콘텐츠를 사용하려는 최종 사용자들 사이에서 리버스 프록시 서버의 형태로 존재.
  - 웹 캐시 서버의 아키텍처와 유사.
- 캐시된 콘텐츠들을 최종 사용자에게 빠르게 전달하기 위해서는 사용자와 가장 가까운 곳에 캐시 서버들이 위치해야 함.
  - 에지 서버(edge server): 사용자와 가장 가까운 곳에 위치한 서버
- `CDN` 업체들은 전 세계 또는 특정 지역에 여러 개의 `POP`을 만들어 에지 노드들을 구성.
  - `CDN` 업체마다 자체 네트워크를 구축하는 방법에는 차이가 있음.

### `CDN` 동작 방법

- 사용자가 웹 사이트에 접속하기 위해 브라우저 주소창에 `URL`을 입력하면 브라우저는 가장 먼저 `DNS`로부터 웹 사이트의 `IP` 주소를 조회.
- 도메인 이름을 조회하는 메커니즘에 의해 최종적으로 웹 사이트를 호스팅하는 조직의 `DNS` 서버가 도메인명에 대한 `IP` 주소를 반환.
- 브라우저는 그 `IP` 주소로 웹 콘텐츠를 요청.
  - 만약 사용자가 웹 사이트 호스팅 서버와 지리적으로 먼 곳에 있다면 요청이 서버에 도착해 응답이 올 때까지의 시간(`RTT`)이 오래 걸림.
- `CDN`을 사용하면 브라우저가 웹 사이트 `IP` 주소를 조회할 때 호스팅 조직의 `DNS` 서버는 자사 서버의 `IP` 대신 `CDN` 서비스 제공자의 도메인명을 반환.
  - 이 경우 사용자 브라우저는 `CDN` 서비스 제공자의 `DNS` 서버에 해당 도메인명에 대한 `IP`를 다시 요청하고 `CDN` 업체의 `DNS` 서버는 사용자와 가장 가까이 위치한 에지 서버의 `IP`를 최종 반환.
- 에지 서버의 `IP`를 받은 브랑줘는 사용자 요청을 그 에지 서버로 보냄.
- 에지 서버는 캐시된 콘텐츠를 사용자에게 빠르게 반환하거나 캐시되어 있지 않은 경우 원본 서버에서 콘텐츠를 받아와서 캐시한 후 브라우저에 응답.

### `CDN` 적용 방법

- 직접 소스 코드를 수정하지 않고 `DNS`만 변경하면 됨.
- `CDN` 서비스 사용 절차
  1. 원본 서버로 사용할 호스트명과 `IP`를 네임 서버의 `A` 레코드로 추가.
     ```shell
     Authoritative Name Server Records
     www.example.com      IN A  106.10.178.36
     org-www.example.com  IN A  106.10.178.36
     ```
  2. `CDN` 설정에 원본 서버의 호스트 명으로 `org-www.example.com`을 등록.
     - `CDN` 네트워크 내의 에지 서버들이 원본 콘텐츠를 찾기 위해 `www.example.com`이 아닌 `org-www.example.com`으로 접속해야 한다는 것을 의미.
     - 만약 `CDN`의 원본 서버로 `www.example.com`을 등록할 경우 이후 세 번째 단계에서 `HTTP` 요청이 `CDN` 내에서 무한 루프에 빠질 수 있으니 주의.
  3. 마지막으로 기존 도메인 명에 부여되어 있던 `IP` 정보를 `CDN` 서비스 제공자의 도메인명으로 변경.
     - `CNAME`: `DNS` 서버에 등록된 도메인명에 다른 도메인 정보를 부여하는 것.
       - 이 레코드를 생성하려면 `CDN` 업체에서 도메인 고유 정보를 부여받아야 함.
     ```shell
      Authiritative Name Server Record
      www.example.com      IN CNAME www.example.cdn.com
      org-www.example.com  IN A     106.10.178.36
     ```
     > 예측하기 쉬운 원본 서버명을 사용하면 `DDoS` 같은 악의적 공격의 표적이 될수 있으므로 기존 서버명의 해시 값을 사용하는 등 공격자들이 쉽게 예측할 수 없는 도메인명 사용을 권장.

---

## 다중 캐시 전략

- 다중 캐시: 사용자와 서버 사이에 여러 개의 캐시 계층을 주어 캐시 효율을 극대화하는 기술.

### 캐시 축출

- 콘텐츠가 `CDN` 서버에 캐시된 후 지정한 만료일까지 온전하게 캐시되어 있지는 않으므로 `CDN`의 캐시 서버는 제한된 용량으로 많은 양의 콘텐츠를 캐시해야 함.
- 캐시 축출(cache eviction): 용량이 일정 한계치에 도달하면 캐시된 콘텐츠에 우선순위를 부여해 낮은 순위의 콘텐츠부터 삭제하는 것.
- 캐시 축출 정책(`CDN` 서비스 제공 업체에 따라 다를 수 있음)
  1. 일정 기간 캐시 적중이 없었던 콘텐츠
  2. 캐시 적중률이 미미한 콘텐츠
  3. 더 오래된 콘텐츠
- 캐시 서버 사용량이 임계치에 도달하면 규칙에 의해 정해진 우선순위에 따라 낮은 순위의 콘텐츠를 삭제하고 새로운 콘텐츠를 캐시.

### 롱테일 콘텐츠

- 특정 콘텐츠가 캐시에서 축출되는 주 요인은 물리적 한계뿐만 아니라 그 콘텐츠의 캐시 적중률이 매우 낮기 때문.
  > 소셜 미디어에서 사용자들은 꾸준히 새로운 콘텐츠들을 공유하지만, 곧 다른 새 콘텐츠들에 의해 빠르게 아래로 밀려나고 특별히 인기 있는 콘텐츠가 아닌 이상 좀처럼 다시 찾아볼 수가 없음.
- 롱테일 콘텐츠: 생성 초기 많이 조회되다가 짧은 시간이 흐른 후 조회 수가 확 줄고 이후 거의 조회되지 않는 콘텐츠.

### 캐시 서버 간 캐시 콘텐츠 공유

- 기본적으로 사용자가 많을수록 캐시 적중률이 높아짐.
- 실제로는 모든 국가나 주요 도시마다 수많은 에지 서버들에 캐시되어 있기 때문에 하나의 에지 서버를 기준으로 실제 사용자 방문에 의한 캐시 적중률은 낮음.
  - 캐시된 콘텐츠가 전 세계에 분산된 에지 서버들 사이에서 마치 하나의 서버를 사용하는 것처럼 공유될 수 있다면 캐시 적중률은 높아짐.
- 에지 서버 간 캐시 공유는 `ICP`(Internet Cache Protocol)와 같은 특별한 프로토콜을 사용해 빠르게 이루어져야 함.
  - 따라서 동일한 백본 네트워크에 연결된 서버 사이에서만 이루어짐.
  - 일반적으로 동일한 `POP` 서버들은 캐시된 콘텐츠를 서로 공유 가능.

### 다중 계층 캐시

- 다중 계층 캐시: 에지 서버들과 원본 서버 사이에 추가 캐시 서버 계층(부모 계층)을 두어 같은 콘텐츠를 여러 번 캐시하는 방식.
- 추가 캐시 계층을 통한 공유 호과를 얻으려면 만족해야 하는 조건
  1. 부모 계층은 원본 서버에 가까이 존재해야 함.
  2. 부모 계층의 캐시 서버 수가 자식 계층의 캐시 서버 수보다 훨씬 적어야 함.

#### 캐시 적중률 향상

- 자식 계층(사용자와 가까운 캐시 계층)의 캐시 서버들은 부모 계층(원본 서버와 가까운 캐시 계층)의 캐시 서버들을 사용해 콘텐츠 공유 가능.
  > 한 팀원이 공유 폴더에 필요한 자료를 올리면 다른 팀원 들이 이를 다운로드할 수 있는 것과 같은 이치.
- 최초로 콘텐츠 요청을 받은 에지 서버가 그 요청을 부모 계층의 에지 서버에 전달.
  - 부모 계층의 에지 서버가 원본 서버에서 콘텐츠를 응답받아 캐시한 후 자신을 호출한 에지 서버에 다시 전달.
    > 부모 계층의 에지 서버에 콘텐츠가 캐시되면 자식 계층의 나머지 에지 서버들은 원본 서버에 콘텐츠를 요청할 필요 없이 부모 계층에서 캐시된 콘텐츠를 받아 서비스.
- 이렇게 함으로써 부모 계층 캐시 서버들의 캐시 적중률이 높아지고, 이에 따라 캐시된 콘텐츠가 캐시 서버에서 축출될 확률도 낮아짐.

#### 과도한 트래픽으로부터 원본 서버 보호

- `CDN` 업체가 제공하는 `POP` 수가 적을수록 원본 서버의 캐시 트래픽은 줄지만 사용자에게 응답하는 속도가 느려짐.
- `POP` 수가 많을수록 원본 서버의 트래픽은 늘어나지맞 사용자에게 응답하는 속도는 빨라짐.
  - 이 경우, 다중 계층 캐시를 사용하면 사용자의 응답 속도를 떨어뜨리지 않으면서 원본 서버로의 트래픽을 획기적으로 줄일 수 있음.
- 트래픽 감소량 계산 예시
  - 하나의 콘텐츠로 1,000명의 사용자가 100대의 에지 서버를 통해 단위 시간(`TTL` 주기) 동안 한 번씩 요청을 보냈다고 가정.
    - 각 에지 서버로 향하는 최초 100개 요청은 캐시된 콘텐츠가 없으므로 원본 서버에 요청을 보내 콘텐츠를 가져옴.
    - 이후 900개의 요청은 이미 캐시된 콘텐츠를 사용하므로 단위 시간당 원본 서버의 트래픽 감소율은 약 90%로 계산.
  - 부모 계층에 10대의 에지 서버를 추가했다고 가정.
    - 에지 서버로부터 원본 서버로 향하는 100개의 요청 중 10개의 요청 만이 추가된 에지 서버를 경유해 원본 서버에 접속하고, 나머지 90개의 요청은 캐시된 콘텐츠를 반환.
    - 총 100개의 요청 중 원본 서버로는 10개의 요청만 전달되므로 부하 감소율은 약 99%.

#### 사용자 요청에 대한 응답 속도 향상

- `CDN` 서비스를 사용하면 일반적으로 사용자에 대한 응답 속도는 빠르지만 `TTL` 주기가 짧을 경우 원본으로 접속하는 요청이 많아지면서 평균 응답 속도에 영향을 미침.
- 다중 계층 캐시를 사용하면 자식과 부모 에지 서버 사이에 전달 경로 최적화가 적용되므로 사용자 요청에 더 빠르게 응답 가능.

---

## 전달 경로 최적화

- `CDN` 서비스 업체들은 콘텐츠 캐시뿐만 아니라 애플리케이션 가속 서비스를 동시에 제공.
  - 모바일 사용자들이 늘고 모바일 애플리케이션의 중요성이 강조되면서 `API` 호출이 속도를 증가시키는 주요 해결책으로 각광.
- 전달 경로 최적화는 애플리케이션 응답 속도를 빠르게 하는 중요한 기능.
  - `API` 호출 같은 동적 데이터뿐만 아니라 캐시가 만료된 콘텐츠를 원본에서 다시 불러올 때도 필요한 기능.
- 전달 경로 최적화 구간
  - 라스트 마일: 최종 사용자와 `CDN` 에지 서버 간 구간
  - 미들 마일: `CDN` 네트워크 구간
  - 퍼스트 마일: 에지 서버와 원본 서버와의 구간

### 라스트 마일 최적화

- 최종 사용자 요청을 가장 가까운 곳에 있는 에지 서버로 전송하는 일.

#### `DNS` 기반 에지 선택

- 사용자 브라우저에 최종적으로 에지 서버의 `IP`를 전달하는 시스템은 `DNS`.
- `CDN` 서비스 업체들은 평소 자사 에지 서버들의 상태와 네트워크 상황을 모니터링하고 있다가 자사 `DNS` 서버로 특정 웹 사이트 도메인명에 대한 쿼리가 요청되면 사용자의 로컬 `DNS`와 가장 가깝고 사용량이 적은 에지 서버의 `IP`를 반환.
- `DNS` 쿼리에는 사용자 기기의 `IP` 정보가 포함되지 않아 실제 사용자 위치를 정확하게 알아낼 수 없음.
  - 대신 사용자 로컬 `DNS` `IP` 정보는 `DNS` 쿼리에 포함되어 있어 이를 활용해 사용자 위치 정보 짐작 가능.
    > 자신이 사용하지 않는 `DNS` 정보를 미리 지정하지 않는 한 가입된 인터넷 제공 업체(`ISP`)에서 제공하는 `DNS`가 자동으로 사용되며, 사용자와 가장 가까운 `DNS` 서버가 배정되도록 최적화되어 있음.
- `DNS` 프로토콜은 매우 기본적이고 안정적으로 사용되기 때문에 `DNS` 기반 에지 선택 방안도 안정적으로 운영됨.
  - `CDN` 제공자에 의해 모든 에지 서버들의 상태가 자세히 모니터링되므로 사용자 요청이 있을 시 최선의 에지 서버가 선택될 확률이 높음.
- 사용자 위치 정보가 실사용자의 아이피 정보가 아닌 인터넷 서비스 제공자의 `DNS` 서버 위치 정보이므로 사용자가 특정 `DNS` 서버를 지정해 사용하는 경우 엉뚱한 곳의 에지 서버가 선택될 수 있음.
  > 최근 많은 사용자들이 구글 `Public DNS` 또는 `Open DNS`를 사용하고 있어 도메인명 조회 시 사용자 `IP` 정보를 일부 포함시키는 방법을 추진 중.

> `ECS`(`EDNS-CLIENT-SUBNET`, `EDECS`)  
> `ECS`는 `DNS` 그룹과 `CDN` 제공 업체들이 공동으로 제안한 `DNS` 확장 규격.  
> `DNS` 리졸버(resolver)가 최종 `DNS` 서버(authoritative `DNS` 서버)에서 도메인명을 조회할 때 쿼리 요청 안에 최종 사용자의 `IP` 정보 일부를 포함해 보내자는 것.

#### 애니캐스트 기반의 에지 선택

- 네트워크에서 데이터를 전송하는 방식
  - 유니캐스트(unicast) 전송 방식
    - 보내는 측과 받는 측이 1:1로 통신하는 방식으로써, 보내는 측은 받는 측 주소를 정확히 알고 메세지를 전송해야 함.
  - 멀티캐스트(multicast) 전송 방식
    - 1:N 통신 방식으로 보내는 측은 받은 노드들의 그룹 주소 또는 포트를 알고 있어야 함.
    - 클러스터(cluster) 환경에서 관리 노드가 자식 노드들을 관리할 때 흔히 사용하는 방식.
  - 브로드캐스트(broadcast) 전송 방식
    - 불특정 다수에게 메세지를 전송하는 방식으로 메세지를 받을지 말지는 전적으로 수신자가 결정.
  - 애니캐스트(anycast) 전송 방식
    - 1:1 전송 방식이지만 유니캐스트와는 다르게 다수 노드가 같은 `IP` 주소를 가짐.
    - 보내는 측이 그 `IP` 주소로 메세지를 보낼 때 네트워크 경로 상 가장 가까운 노드를 선택해 전송하는 방식.
    - 보내는 측의 라우터(router)와 경계 경로 프로토콜(Board Gateway Protocol, `BGP`)에 의해 전송될 노드가 결정.
- 애니캐스트 기반 에지 선택 방식에서 `CDN` 제공자는 모든 에지에 동일 `IP`를 부여하거나 지역별 클러스트를 만들어 클러스트마다 다른 `IP`를 부여하기도 함.
- 사용자 브라우저가 웹 사이트의 도메인명에 대한 `IP` 정보를 요청하면 최종적으로 `CDN`의 `DNS` 서버가 사용자에게 가장 가까운 지역의 `IP`를 반환.
  - 브라우저가 그 `IP`에 `HTTP` 요청을 보내면 애니캐스트 방식에 의해 가장 가까운 에지 서버가 자동 선택되어 요청을 처리.
- 애니캐스트 선택 방식의 장점은 실제 사용자와 가장 가까운 네트워크의 에지 서버가 선택된다는 것.
  - 하지만 실제 사용자와 지리적으로 가장 가까운 에지 선택을 보장하지 않음.
  - 애니 캐스트에 사용되는 `BGP`는 지리적 경로보다 `ISP` 정책에 따른 경로를 선택하기 때문.
  - 이러한 정책은 저비용과 고효율에 기반하여 결정되므로 결국 `ISP` 간 계약 관계에 따라 최적 경로가 결정되며, 이를 **네트워크적으로 가장 가깝다**고 표현.
- `BGP`를 통한 경로 탐색 시 에지 서버들의 성능 상태를 고려하지 않기 때문에 간혹 수행되지 않는 에지 서버 선택 가능.
  - 서버 자체가 죽지 않는 이상 라우터는 네트워크상에서 발견되는 모든 서버를 양호하다고 간주.
    > 애니캐스트를 사용하는 `CDN` 업체들은 이러한 문제를 해결하려고 에지 서버들의 상태를 감시하면서 용량 임계점에 도달한 서버는 네트워크 라우팅 테이블에서 제외하는 등의 방안 제공.

<br />

- 라스트 마일 구간에서 최적의 에지 서버를 찾았다면 퍼스트 마일에서는 최적의 원본 서버를 찾아야 함.
- 다수 데이터 센터를 통해 고가용성을 유지하고자 한다면 상황에 따라 적절한 데이터 센터를 찾아 사용자 요청을 전달하고 응답을 받는 것이 중요.
- 트래픽 분산 방식(`CDN` 업체마다 지원 여부에 차이가 있을 수 있음.)
  - 비율에 따른 트래픽 분산
    - 각 데이터 센터로 전송하는 트래픽을 지정한 비율에 맞추어 분산.
  - 지역에 따른 트래픽 분산
    - 지역을 구분하여 사용자 위치에 가장 가까운 데이터 센터로 `HTTP` 요청을 보내 빠르게 처리.
  - 성능에 따른 트래픽 분산
    - 각 데이터 센터의 성능을 고려해 트래픽을 분산.
    - 데이터 센터가 서버들의 성능 정보를 `CDN` 업체와 공유하면 `CDN`에서는 데이터 센터의 가용량에 따라 사용량이 적은 데이터 센터로 트래픽을 보내 처리.
- 데이터 센터가 선택되면 에지 서버가 사용자 요청을 선택된 데이터 센터로 전송.
  - 한 가지 주의할 점은 한 사용자 요청이 어떤 하나의 데이터 센터에서 처리되었다면 그 사용자의 이어지는 요청들이 모두 똑같은 데이터 센터에서 처리되어야 한다는 것.
  - 웹 사이트를 사용하는 동안 사용자의 로그인 세션이 끊기지 않도록 하려는 것.
    > 이를 위해 `CDN`에서는 사용자 쿠키에 선택된 데이터 센터의 정보를 넣어 동일 사용자 요청들은 동일 데이터 센터로 전송되도록 함.

> `CDN`과 sticky session  
> `OSI` 7계층 중 `L3`, `L4` 장비로 부하 부산을 할 때 사용자 세션을 유지시키기 위해 클라이언트 `IP` 정보 기반으로 부하를 분산하는 방식을 사용하기도 하는데, 이를 **해시 방식**이라고 함.  
> 해시 방식이란, 최초 `HTTP` 요청이 인입되면 이를 요청한 클라이언트 `IP` 정보를 입력값으로 해시값을 계산해 그 값에 따라 처리할 서버를 선택한 뒤 이후 요청들에 대해 동일 해시값이 계산되면 동일 서버로 요청을 보내 처리하게 하는 방식.
>
> 이런 방식은 `CDN` 서비스를 이용하면 정상 동작하지 않을 수 있음.  
> 이는 `CDN`의 에지 서버가 클라이언트와 서버 사이에 존재하므로 `L3`, `L4` 장비가 인식하는 클라이언트 `IP`가 실제로는 에지 서버의 `IP`이기 때문.  
> 이 에지 서버는 한 사용자가 웹 사이트를 누비는 동안에도 네트워크 상황에 따라 언제든 바뀔 수 있기 때문에 동일 사용자 요청을 서로 다른 서버로 보내 세션이 끊길 가능성이 높음.  
> 따라서 `CDN`을 사용하려면 `L3`, `L4` 장비의 부하 분산에 의존하기보다 웹 서버를 사용한 부하 분산 또는 `L7` 계층 부하 분산 등 애플리케이션 계층에서 쿠키 기반 부하 분산을 사용하는 것을 권장.

- 미들 마일 경로 최적화는 사용자 요청을 받은 에지 서버와 원본 서버 같 가장 빠른 네트워크 경로를 찾아내는 작업.
- 일반적으로 에지 서버는 `BGP` 프로토콜을 이용해 최선의 경로를 찾아냄.
  - `BGP`가 가장 빠른 경로를 보장하지 않으며 지리적 최적 경로를 찾았다 할지라도 그 네트워크 구간에 트래픽이 몰리면 우회 경로보다 더 오랜 시간 지연을 초래하기도 함.
- `CDN` 서비스 제공자들은 원거리 네트워크 경로 최적화를 위해 많은 `ISP` 업체들과 협업 관계를 유지.
  - 각 나라의 대표적인 `ISP` 데이터 센터 또는 `POP` 내에 자사의 에지 노드들을 구축해 언제든 우회 경로를 생성할 수 있는 환경 구축.
  - 자사 네트워크 구간을 끊임없이 모니터링해 정체 구간을 파악하고 사용자가 특정 원본 서버의 웹 콘텐츠를 요청하면 두 구간의 최적 경로 파악 후 선택된 경로로 요청과 응답을 전송.
  - 최적 경로를 파악하는 알고리즘은 `CDN` 업체마다 다름.
    > `BGP`로 선택된 경로와 모니터링으로 선택된 2개 경로를 경합시켜 가장 빠른 경로를 최종 선택하는 방식도 존재.

### 프로토콜 최적화

- 사용자 기기와 원본 서버 간 웹 트래픽 가속화를 위해 경로 최적화와 더불어 프로토콜 최적화가 병행되어야 함.
- 경로 최적화가 빠른 길을 찾는 과정이라면 프로토콜 최적화는 한 번에 많은 트래픽을 보낼 수 있도록 길을 넓히는 작업.
- 웹 트래픽은 `HTTP`를 기반으로, `HTTP`는 `TCP/IP` 프로토콜을 기반으로 동작.
- 보내는 측과 받는 측이 `3-way handshake` 방식으로 `TCP`를 연결하고 본격적으로 데이터 패킷을 주고받음.
  - 이때 요청 및 응답을 더 빠르게 전달하려면 한 번에 가능한 많은 패킷을 보내는 것이 유리.
    - 보내는 측이 많은 데이터 패킷을 보낸다 해도 받는 측이 이를 모두 수용할 수 있는 것은 아님.
  - 받는 측이 수용할 수 없는 양의 데이터를 한꺼번에 보내 데이터가 유실되면 보내는 측에서 다시 유실 데이터를 전송해야 하므로 네트워크 자원을 낭비.
  - 이러한 상황을 제어하기 위해 받는 측은 윈도우 사이즈(Receivers Advertised Window Size, `RWIN`). 즉, 수신 가능한 데이터 크기를 서버에 통지.
    - 보내는 측은 항상 받는 측의 윈도우 사이즈 값을 고려해 그보다 더 적은 양의 데이터를 보내야 함.

#### `TCP` 최적화

- 모든 네트워크 참여자들이 무분별하게 많은 패킷들을 한 번에 보내면 공용으로 써야하는 네트워크가 혼잡해져 모두에게 피해가 갈 수 있음.
- `TCP`는 이러한 혼잡 상황을 제어하기 위해 **느린 시작**(slow start)이라는 알고리즘을 사용.
- 느린 시작이란, 송신 측이 전송을 시작할 때 적은 양의 데이터부터 전송하는 것을 의미.
- 이렇게 전송하는 데이터의 크기를 **혼잡 윈도우**라고 함.
- 느린 시작 동작
  1. 초기 혼잡 윈도우에 정해진 만큼 데이터 패킷을 전송.
  2. 문제가 없으면 혼잡 윈도우 값은 제곱으로 증가.
  3. 네트워크가 혼잡해 재전송 타임아웃(Resubmit Time Out, `RTO`)이 발생하면 현재 혼잡 윈도우의 절반 값으로 임계치가 설정되고 처음부터 다시 전송을 시작.
  4. 이후 혼잡 윈도우 값이 정해진 임곗값보다 커지면 혼잡 회피를 위해 혼잡 윈도우 값은 제곱이 아닌 선형으로 증가.
  5. 이후 임곗값은 패킷 유실이나 네트워크 에러, 중복 응답 등에 따라 다른 방식으로 계산되어 정해짐.
- `CDN` 구간에서 최적화 진행 방법
  - `TCP`를 최적화하려면 먼저 미들 마일의 네트워크가 잘 관리되고 양호하다는 전제가 있어야 함.
    - 일반적으로 `CDN` 제공자들은 대형 `ISP`들과 파트너십을 맺어 경로 최적화가 잘 이루어졌기 때문에 이런 전제 성립 가능.
  1. 초기 혼잡 윈도우 값을 늘려 한 번에 많은 데이터를 보낼 수 있게 함.
  - 보통 이더넷 환경에서 초기 혼잡 윈도우 기본값은 `3MSS`(Maximum Segment Size).
  - 아무리 네트워크 상황이 뛰어나다 해도 서버는 초기에 3개의 패킷부터 보내야 함.
  - 이 때문에 `CDN` 업체들은 자사의 미들 마일 구간에서 수신 에지 서버의 윈도우 사이즈와 송신 에지 서버의 초기 혼잡 윈도우 값을 크게 늘려 한 번에 보낼 수 있는 패킷 양을 늘림.
  2. `RTO` 값을 낮춰 실패한 패킷을 빠르게 재전송함.
  - 일반적으로 `TCP` 환경에서는 네트워크 혼잡에 의한 `RTO` 값이 수 분까지 길어질 수 있음.
    - 즉, 수신 측까지의 네트워크의 일시적 문제로 패킷이 전송되지 못 했을 때도 서버는 몇 분 이상 기다려야 이 상황을 인지하고 재전송한다는 뜻.
  - `CDN`은 이 값을 낮춰 누락 데이터를 훨씬 빠르게 전송.
  - 이외에도 임계치 수치가 급격히 떨어지는 비율을 낮추거나 임계치 이후 혼잡 윈도우 증가량을 늘리는 등 다양한 최적화 방법을 사용.
- 이러한 이로는 퍼스트 마일에서도 적용 가능하며, 퍼스트 마일에서는 데이터를 송신하는 측이 원본 서버가 됨.

> 혼잡 윈도우를 늘리면 네트워크 트래픽이 갑작스럽게 증가하는 현상이 생길 수 있으니 충분히 검토 후 결정해야 함.

#### `TLS` 종료와 `TCP` 연결 재사용

- `HTTP` 통신을 위해 클라이언트와 서버는 `TCP` 연결을 맺기 위한 `3-way handshake`를 수행하며, 추가로 상호 인증서를 확인하고 메세지를 암호화하기 위한 `TLS handshake`를 수행함.
  - 클라이언트와 서버 사이 네트워크 거리가 멀다면 이에 소요되는 시간이 길어ㄷ지고, 모바일 환경에서는 더 심해질 수 있음.
- `CDN` 서비스를 사용하면 최종 사용자는 `CDN`과 `TCP` 연결을 맺고 `CDN`은 원본 서버와 또 다른 `TCP` 연결을 생성.
- `HTTP` 통신을 할 때 `TLS handshake`는 최종 사용자와 `CDN`사이, `CDN`과 원본 서버 사이에 한 번씩 발생.
  - 모든 사용자가 `CDN`의 에지 서버와 `TCP/IP` 연결을 생성할 때 에지 서버가 원본 서버와 사용자 수 만큼의 연결을 새로 한 번 더 생성하는 것은 비효율적.
  - 그래서 `CDN` 서비스 제공자들은 효율성을 높이기 위해 원본 서버와의 `TCP` 연결을 바로 끊지 않고 이미 생성된 연결들을 재사용.
- `CDN` 서비스를 사용하면 원본 서버는 기존처럼 많은 `TCP` 연결을 생성하고 유지할 필요가 없어 서버 자원을 아낄 수 있음.

> 최종 사용자는 멀리 떨어진 원본 서버가 아닌 가장 가까운 에지 서버와 `TCP`, `TLS handshake`를 수행하므로 응답 속도 개선.

> 프로토콜 다운그레이드  
> 성능을 이유로 사용자와 `CDN` 구간만 `HTTPS`로 연결하고 `CDN`과 원본 구간은 `HTTP` 연결을 유지하는 경우가 있음.  
> 암호화된 연결을 사용하지 않으면 중간자 공격(man in the middle)의 위험성이 항상 존재.  
> 중간자 공격: 클라이언트와 서버 사이 네트워크 통신에 침투하여 전송 데이터를 복제 또는 위조하는 공격.  
> `CDN` 에지 서버와 원본 서버가 프라이빗 네트워크에 있지 않다면 누구도 이러한 공격에서 안전하다고 장담할 수 없으므로 전 구간에서 항상 암호화된 통신을 사용해야 함.

---

## 기타 성능 옵션

- `CDN` 서비스를 사용하는 장점 중 하나는 웹 사이트 호스팅 서버에서 제공하지 못했던 기능을 `CDN`이 제공한다는 것.

### `CDN`이 대신 제공하는 기본 기능

#### `HTTP` 압축

- 텍스트 파일 전송 시에 압축은 매우 중요한 역할을 하며 대부분 브라우저는 `gzip` 압축 방식을 지원.
- `gzip`으로 `HTML`, `CSS`, `JavaScript`, `SVG` 등의 텍스트 파일을 압축하면 약 75% 정도 크기를 줄일 수 있음.
- 압축을 적용하면 네트워크 대역폭을 절약 가능하며, 사용자가 콘텐츠를 다운로드하는 속도도 빨라짐.

  - `Apache` 웹 서버 예시

    ```apache
    # 아파치 모듈 추가
    LoadModule deflate_module modules/mod_deflate.so

    # 압축 대상 추가
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    ```

- `CDN` 서비스를 사용 중이라면 에지 서버는 기본적인 텍스트 파일 포맷 위에 위와 같은 `gzip` 압축을 적용해 브라우저로 전송.
  - 이를 잘 활용하려면 웹 사이트에서 사용되는 모든 텍스트 파일 형식을 확인해 `CDN` 압축 설정에 추가해야 함.
  - `JSON`, `SVG`, `EOT`, `TTF` 등
- `CDN`이 제공하는 압축은 에지 서버와 브라우저 네트워크 구간에만 적용됨.
- 그러므로 호스팅 서버와 에지 서버 사이의 네트워크 구간을 가속화하려면 서버 측에서 압축 설정을 해야 함.

#### 브라우저 캐시

- `CDN` 서비스를 사용하면 콘텐츠 캐시 주기를 별도로 설정.
  - 따라서 서버가 `CDN`에 콘텐츠를 캐시하기 위해 `Cache-Control: max-age`나 `expire` 헤더를 사용할 필요가 없음.
- 대부분 `CDN` 업체는 브라우저를 위한 `Cache-Control`을 어떻게 처리할 것인지 옵션을 제공.
  1. `CDN`에 설정한 `TTL` 값을 그대로 사용.
     - 응답 시점에 에지 서버에 설정된 캐시 주기 값을 기반으로 남은 시간과 만료일을 계산해 `Cache-Control` 헤더 값을 설정 후 브라우저에 전송.
     - 에지에 캐시된 콘텐츠 주기가 만료되는 시점에 브라우저 캐시도 같이 만료되는 가장 일반적인 방식.
  2. 서버에서 응답한 헤더를 그대로 브라우저로 전송.
     - 서버에서 직접 캐시를 조정하고자 할 때 사용.
     - 콘텐츠 갱신 주기가 일정하지 않고 잦은 이벤트로 융통성 있는 캐시 주기 조절이 필요할 경우에 유용.
  3. `CDN`에 설정한 캐시 주기와 서버 응답 헤더의 캐시 주기 중 더 길게 남은 값을 사용.
     - 가능한 오랫동안 브라우저의 캐시를 활용하고 싶을 때 사용.
     - 콘텐츠를 수정하고 긴급히 반영해야 할 경우 `CDN`의 캐시를 지우고 브라우저 캐시까지 `Cache-Control` 헤더로 지워야 하므로 관리가 복잡.
       - 캐시 삭제가 잘 수행되지 않아 콘텐츠 변경 사항이 신속히 갱신되지 않으면 브라우저에서 웹 페이지 깨짐 현상이 나타날 수 있음.
         - 중요 업데이트를 놓쳐 소비자 불만 발생 가능성.
     - 자주 변경해야 하거나 사용자에게 신속히 반영되어야 하는 중요 콘텐츠에는 사용하지 않는 것을 권장.
  4. `CDN`에 설정한 캐시 주기와 서버 응답 헤더의 캐시 주기 중 더 짧게 남은 값을 사용.
     - 상대적으로 브라우저가 에지 서버에 콘텐츠 변경 여부를 자주 물음.
     - 콘텐츠가 변경되면 브라우저에도 그만큼 신속하게 변경 사항이 반영.
  5. 브라우저 캐시를 사용하지 않음.
     - `Cache-Control: max-age=0; no-store` 헤더를 브라우저에 전송해 항상 에지에서 콘텐츠를 다운로드하게 함.
     - 사용자가 브라우저 캐시 때문에 잘못된 정보를 받는 일이 없도록 하고 싶을 때 사용.

#### `HTML`, `CSS`, `JavaScript` 최소화

- 에지 서버에서는 응답 콘텐츠에서 공백, 주석 등을 제거해 캐시한 후 같은 요청에 대해서 이미 최적화된 콘텐츠를 제공함으로써 사용자에게 응답하는 속도를 높일 수 있음.

#### `DNS` 프리패치와 프리커넥트

- 웹 개발자는 `<link>` 태그를 사용해 브라우저에 성능 개선 힌트를 줄 수 있음.
  ```html
  <link rel="dns-prefetch" href="//image.example.com" />
  ```
- 모든 웹 페이지에 위의 `<link>` 태그를 삽입하기 어렵다면 `CDN`에서 제공하는 `DNS` 프리페치 기능 사용 가능.
  ```shell
  Link: <http://image.example.com>; rel=dns-prefetch
  ```
- 최근에는 `DNS` 조회와 더불어 `TCP` 연결까지 미리 생성하는 프리커넥트(preconnect)가 추가되었으니 더 큰 성능 개선 효과를 얻을 수 있음.
  ```shell
  Link: <http://image.example.com>; rel=preconnect
  ```

### 신기술 적용을 위한 `CDN` 기능

- `CDN` 서비스 제공 업체들은 경쟁력을 위해 네트워크가 웹 기술에 관심을 기울이고 이와 관련된 신기술을 누구보다 빠르게 검증하고 도입.

#### `HTTP/2`와 `HTTP/3`

- `CDN` 네트워크에서 `HTTP/2`는 대부분 브라우저와 에지 서버 사이 구간에서만 캐시할 수 있는 정적 콘텐츠를 가속하는 데 사용.
- 원본 섭의 `HTTP/2` 지원 여부와 상관없이 이를 적용하고 사용자들에게 `HTTP/2`의 이점을 제공 가능.
- `HTTP/3`는 `HTTP/2`보다 빠르고 안전한 차세대 프로토콜로써 활발하게 표준화 논의가 진행 중.
  - 아직은 `CloudFlare`에서만 유일하게 지원하고 있음.

#### 서버 푸시

- `HTTP/2`의 주요 기능 중 하나인 서버 푸시 기능은 `CDN` 설정에 `HTTP/2` 기능을 추가해도 즉시 사용할 수 없는 조금 특별한 기능.
- 서버 푸시: 리소스에 대한 다운로드 요청을 보내지 않아도 필요한 자원들을 미리 전송해주는 기능.
- 필요한 자원들을 미리 푸시하려면 웹 페이지를 로딩하는 데 중요한 자원들이 무엇인지 분석하고 결정해서 푸시 대상으로 지정하는 일련의 작업을 해야 함.
- 서버 푸시가 푸시 대상을 지정하는 방식
  1. `CDN`에 푸시할 자원들을 미리 지정하는 방식.
     - `CDN`에 푸시할 자원들을 미리 지정하면 `CDN`은 `HTML` 요청을 받는 즉시 푸시 객체를 브라우저에 보냄.
     - 브라우저는 푸시 객체를 파악하려 서버에 요청을 보낼 필요가 없어 더 빠르게 로딩 시작 가능.
     - 다만, 푸시 객체를 변경하려는 경우 `CDN` 설정을 변경해야 하고, 페이지 별로 푸시할 대상이 다르면 각 페이지마다 이를 설정해야 하는 번거로움 존재.
  2. 웹 페이지에 푸시할 리소스를 태그로 지정하는 방식.
     - 일반적으로 푸시 리소스를 판단하기 위해 `<link>` 태그의 `preload`를 많이 사용.
       ```html
       <link rel="preload" href="style.css" as="style" />
       ```
     - `CDN` 에지는 원본 서버에서 응답받은 `HTML`에 `preload`로 지정된 리소스가 있을 경우 미리 캐시된 그 리소스를 푸시.
     - 원본 서버에서 푸시할 리소스를 자유롭게 조정할 수 있다는 점에서 매우 융통성 있는 방식.
     - 다만, 푸시 객체 판단을 위해 적어도 한 번은 원본 서버에 다녀와야 하므로 다른 방식보다 약간의 시간 지연 발생.

#### `IPv6` 듀얼 스택

- 인터넷 사용자가 급증하여 `IPv4`로 할당할 수 있는 `IP` 주소는 이미 포화 상태.
- 무한대에 가까운 `IP` 주소를 제공할 수 있는 생성 메커니즘이 절대적으로 필요.
- `IETF`(Internet Engineering Task Force)에서는 이와 같은 `IP` 주소의 필요성을 이미 인식해 1996년 `IPv6`를 만들어 발표.
  - `IPv4`가 32비트 길이를 사용해 주소를 만드는 반면, `IPv6`는 128비트 길이를 사용하므로 약 340조 개의 고유 `IP`를 만들 수 있음.
- `IPv6`의 장점
  1. 128비트 길이를 사용해 방대한 주소 생성 가능. 이를 이용해 모든 사용자에게 직접 주소를 지정할 수 있어 별도의 네트워크 주소 변환(`NAT`) 장치가 필요하지 않음.
  2. `IPv4`의 헤더에서 불필요한 부분을 제외해 간소화. 헤더가 복잡하면 헤더 처리에 많은 작업이 필요하므로 패킷 처리 효율이 떨어짐.
  3. 자동 구성 기능을 제공해 훨씬 단순하며 관리하기 용이.
  4. `IPv6`의 자동 네트워킹 기능은 단말기를 움직일 때마다 고유 `IP`를 자동으로 설정. `IP`를 재부여 받거나 재설정해야 했던 `IPv4`의 단점 해소.
  5. 등급별, 서비스별로 패킷을 구분할 수 있어 품질 보장 가능.
  6. 보안 기능 강화. `IPv4`는 보안 기능(`IPSec`)을 별도 설치해야 하지만, `IPv6`는 확장 기능을 통해 보안 기능을 기본으로 제공.
- 많은 장점을 제공하는 `IPv6`이지만 기업 네트워크 인프라스트럭처를 전환하는 것은 간단하지 않으며, 여전히 많은 웹 사용자들이 `IPv4`를 사용하고 있음.
- `CDN` 서비스 제공자들은 `IPv4`/`IPv6`를 모두 사용할 수 있는 듀얼 스택을 장착해 `IPv6`의 장점을 미리 경험할 수 있는 기회를 제공.
