# CDN

## 7.1 CDN을 사용하는 이유
- 웹 캐시 서버들을 분산 배치하고 컨텐츠들을 캐시해 빠르게 응답할 수 있도록 하는 기술
- CDN 사용의 이점
  1. 성능 및 안정성 보장
  2. 아키텍처 단순화
  3. 높은 비즈니스 투자 수익
- CDN 특징
  1. 동적 컨텐츠 가속
  2. 프런트엔드 최적화
  3. 동영상 또는 라이브 스트리밍 서비스
  4. 클라우드 보안
  
## 7.2 CDN의 원리

### 7.2.1 CDN서비스 아키텍처
- CDN 서비스는 클라이언트, 서버간 리버스 프록시 서버 형태로 존재
- 사용자가 많고 가까운 곳에 에지 노드들을 구성

### 7.2.2 CDN 동작 방법
<img src="img/img_13.png" width="600px" height="400px">

- CDN 적용 전

<img src="img/img_14.png" width="600px" height="400px">

- CDN 적용 후

## 7.3 다중 캐시 전략

### 7.3.1 캐시 축출
- 캐시 축출: 제한된 용량을 가진 서버가 우선순위가 낮은 컨텐츠를 삭제하는 것
  1. 일정 기간 캐시 정중(cache hit)이 없었던 컨텐츠
  2. 캐시 적중률(cache hit rage)이 미미한 컨텐츠
  3. 더 오래된 컨텐츠

### 7.3.2 롱테일 컨텐츠
- 인기가 없고 기간이 오래되어도 지워지지 않은 컨텐츠
- 생성 초기 많이 조회되다가 짧은 시간이 흐른 후 거의 조회되지 않는 컨텐츠를 말함

### 7.3.3 캐시 서버 간 컨텐츠 공유
- 캐시된 컨텐츠가 분산된 에지 서버들 사이에 하나의 서버를 사용하는 것처럼 공유하는 것
- ICP(Internet Cache Protocol)와 같은 특별한 프로토콜을 사용해 빠르게 캐시 공유

### 7.3.4 다중 계층 캐시

- 전 세계에 흩어져 있는 캐시 컨텐츠들을 공유하기 위해 다중 캐시 전략을 사용할 수 있음

<img src="img/img_15.png" width="600px" height="400px">

- 다중 캐시 원리
  1. 컨텐츠 요청을 받은 에지 서버가 부모 계층 에지 서버에 전달
  2. 부모 계층에서 응답을 캐시
  3. 사용자는 부모 계층에 캐시된 컨텐츠들을 사용

- 다중 캐시 계층의 효과
  - 캐시 적중률 향상
  - 트래픽으로부터 원본 서버 보호
  - 사용자 요청에 대한 응답 속도 향상
  
## 7.4 전달 경로 최적화

<img src="img/img_16.png" width="600px" height="400px">

### 7.4.1 라스트 마일 최적화
- 최종 사용자 요청을 가장 가까운 에지 서버로 전송하는 일
### 에지 서버 선택 방법

#### 1. DNS 기반 에지 선택

<img src="img/img_17.png" width="600px" height="400px">

- CDN 서비스 업체들은 자사 DNS 서버로 요청이 오면 로컬 DNS와 가장 가깝고 사용량이 적은 에지 서버의 IP를 반환

#### 2. 애니캐스트 기반 에지 선택
> 유니캐스트: 보내는 측과 받는 측이 1:1로 통신하는 방식   
> 멀티캐스트: 1:N 통신 방식으로 보내는 측이 받는 노드들의 그룹 주소 또는 포트를 알고 있어야 함   
> 브로트캐스트: 불특정 다수에게 메시지를 전송하는 방식으로 수신자가 수신 여부를 결정   
> 애니캐스트: 1:1 전송 방식으로 다수의 노드가 같은 IP를 가지며 보내는 측이 최적의 노드를 선택해 전송하는 방식

<img src="img/img_18.png" width="600px" height="400px">

- 최적 경로의 에지 노드를 선택

##### 퍼스트 마일
- 최적의 원본 서버를 찾아야 함
- 하나의 데이터 센터를 사용한다면 효과적이지 않지만 다수의 데이터 센터를 사용한다면 적절한 경로를 찾는 것이 중요
- 트래픽 분산
  - 비율: 일정한 비율에 맞추어 분산
  - 지역: 지역을 구분하여 가장 가까운 데이터 센처로 요청
  - 성능: 각 데이터 센터의 성능을 고려해 트래픽 분산

### 7.4.2 프로토콜 최적화

## 7.5 기타 성능 옵션

### 7.5.1 CDN이 대신 제공하는 기본 기능

#### HTTP 압축
- 텍스트 파일 전송 시 압축은 중요한 역할을 하며 브라우저는 gzip 압축 방식을 지원

#### 브라우저 캐시
- 브라우저 캐시는 컨텐츠가 변경 되었는지 검사하고 변경된 파일만 다운로드
- CDN 업체는 브라우저를 위한 Cache-Control을 어떻게 처리할 것인지 옵션을 제공
  1. CDN에 설정한 TTL 값을 그대로 사용
  2. 서버에서 응답한 헤더를 그대로 브라우저로 전송
  3. CDN에 설정한 캐시 주기와 서버 응답 헤더의 캐시 주기 중 더 길게 남은 값을 사용
  4. CDN에 설정한 캐시 주기와 응답 헤더의 캐시 주기 중 더 짧게 남은 값을 사용
  5. 브라우저 캐시를 사용하지 않음

#### HTML, CSS, JavaScript 최소화
- 텍스트 파일 사이즈를 줄이거나 CDN업체에서 제공하는 최적화 기능을 사용

#### DNS 프리페치와 프리커넥트
- 앞으로 사용될 도메인의 IP 정보를 미리 쿼리
- 리소스를 다운로드할 도메인이 많은 경우 다운로드 시점에 IP 검색 시간을 줄일 수 있음
```html
<link rel="dns-prefetch" href="//image.example.com" /> 
```
- link 태그를 사용하기 어렵다면 CDN에서 제공하는 프리페지 기능을 사용할 수 있음
> Link: <https://cdn.example.com/image.png>; rel=dns-prefetch
- TCP 연결까지 미리 생성하는 프리커넥트
> Link: <https://cdn.example.com/image.png>; rel=preconnect

### 7.5.2 신기술 적용을 위한 CDN 기능

#### HTTP/2와 HTTP/3
- CDN 네트워크에서 HTTP/2는 대부분 브라우저와 에지 서버 사이 구간에서만 개시할 수 있는 정적 컨텐츠를 가속하는데 사용
- 따라서 원본 서버의 HTTP/2 지원 여부와 상관없이 적용 가능

#### 서버 푸시
- 리소스에 대한 다운로드 요청을 보내지 않아도 필요한 자원들을 미리 전송해주는 기능
1. CDN에 푸시할 자원들을 미리 지정하는 방식

<img src="img/img_19.png" width="600px" height="400px">

2. 웹 페이지에 푸시할 리소스를 태그로 지정하는 방식
> <link rel="preload" href="style.css" as="style" />

<img src="img/img_20.png" width="600px" height="400px">