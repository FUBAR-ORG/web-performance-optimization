# 4장. 이미지 최적화

## 4.1. 이미지의 중요성

- 고품질 이미지로 브랜드 가치나 상품을 홍보하기 때문에 이미지의 중요성은 날로 커진다.
- 초고속 인터넷 시대에 접어들며 이미지의 크기는 점점 커지는 추세이다.
- 이러한 추세는 고해상도 디스플레이의 발전과 연관되어 있다.

### 화소밀도

- 물리 스크린 공간 안에 얼마나 많은 픽셀이 압축 되어있는가 의미
- 픽셀비율(DPR)로 표현

## 4.2. 디지털 이미지의 종류와 특성

- PNG 파일은 알파 채널 이라는 이미지 변환 기법을 사용한다.
- 투명 기능이 필요하지 않으면 JPGE로 변환해서 사용하는 것이 유리하다.

### 4.2.1 래스터 이미지 vs 벡터 이미지

- 래스터 이미지는 우리가 사용하는 대부분의 이미지 유형이다.
- 작은 사각형 모양의 픽셀에 표현하고자 하는 색상 정보를 입력해 컴퓨터로 표현하는 방식이다.

- 벡터이미지는 그리고자 하는 대상의 수학적인 정보를 제공한다.
- SVG 파일이 w3c 표준 포맷으로 가장 많이 사용된다.
- SVG 파일은 텍스트 기반 콘텐츠 이므오 gzip이나 brotli 같은 텍스트 압축 기법으로 간단히 최적화 할 수 있다.

### 4.2.2 무손실 이미지 형식 vs 손실 이미지 형식

- 원본 이미지의 정보 손실을 허용하지 않으면 무손실 이미지라한다.
- 정보 손실을 어느정도 허용하면 손실이미지라한다.

### GIF

- GIF는 이동식 이미지 형식
- 색이 256 컬러로 매우 제한적
- 트루 컬러 타입인 GIF 이미지로 변형하여 사용할 수 있지만 이 경우 파일 사이즈가 기하급수적으로 커져 비효율적이다.

### PNG

- 256색만 사용할 수 있는 GIF의 단점과 특허 문제를 해결하기 위해 개발되었다.
- 웹사이트는 알파채널 이라고 불리는 투명 기능 때문에 PNG가 많이 사용된다.
- PNG는 컬러 팔레트 PNG와 트루컬러 PNG로 나눌 수 있다.
- 웹 사이트에서 사용되는 PNG는 알파 채널이 추가된 트루 컬러 PNG이다.

### JPEG

- JPEG는 사진을 저장하는 표준 형식이다.
- RAW파일은 크기가 너무 크기때문에 네트워크 전송이나 웹에 게시하기 어렵다.
- JPEG는 사람의 눈이 인식할 수 있는 색상만 남기고 나머지를 제거하는 방식
- 고해상도 이미지를 크게 압축한 파일로 저장할 수 있다.
- 투명이능이나 애니메이션을 지원하지 않는 단점이있다.

### JPEG 2000

- JPEG의 압축 방식과 달리 새로운 방식을 사용하여 이미지 압축률을 높였다.
- 무손실 압축 및 투명 기능, 애니메이션 기능을 지원한다.
- 16,24,32 비트 등 다양한 색상을 지원하지만 더 많은 프로세싱 자원이 필요하다.

### WebP

- 구글에서 개발하고 배포한 이미지 형식
- JPEG보다 개선된 공격적 압축 방식을 사용하여 파일 크기를 25~35% 정도 작게 만든다.
- 무손실 압축, 애니메이션 기능, 투명 기능도 모두 지원된다.

### JPEG XR

- JPEG XR은 마이크로소프트 사에서 개발한 이미지 형식
- JPEG는 무손실 압축, 투명 기능 지원, 점진적 데이터 전송 지원

## 4.3 이미지 변환 기법

### 4.3.1 무손실 압축

- 무손실 압축을 하려면 각 이미지 유형을 다르게 처리해야 한다.
- 스크립트를 통해 압축을 자동화 할 수 있다.
- 매번 수동으로 변환하기 번거롭기 때문에 무료로 배포되는 라이브러리의 명령어들을 이용해 자동화 한다.

#### GIF

- 256색상으로 만들어진다.
- 애니메이션이 포함되어 있지 않다면 압축률이 높은 PNG8이나 각 브라우저에 특화된 이미지 형식으로 변경하는것을 권장

#### PNG

- PNG는 PNG임을 알리는 구분자인 첫 8바이트 서명을 제외하고 `청크` 형태로 이미지 정보를 저장한다.
- 이러한 청크는 웹 렌더링에 필요 없으므로 삭제할 수 있다.

#### JPEG

- JPEG는 많은 메타데이터가 포함되어 있다.
- 이 메타 정보를 삭제하면 이미지 품질 손실 없이 파일의 크기를 줄일 수 있다.

### 4.3.2 손실 압축

- 손실 압축은 특정 이미지 정보를 누락, 즉 손실 시켜 파일 크기를 줄이는 방식이다.
- 예를 들어 이미지 색이 비슷한 부분의 색을 하나의 색으로 통일해 그만큼의 정보를 손실시켜도 사용자는 눈치채지 못한다.
- 고화질의 이미지를 제공하고 싶다면 손실 압축을 피해야한다.

## 4.4 반응형 웹에서의 이미지 배치 전략

### 4.4.1 반응형 웹의 문제점

- 반응형 웹은 성능 측면에서 효과적이지 못했다.

### 4.4.2 원인은 이미지

- 웹 환경에 따라 변하지 않는 이미지 크기
- 화면이 작아졌는데도 필요 이상의 웹 리소스들을 과하게 내려받는 현상이 발생은 세가지로 구분
  - 내려받아 줄이기
  - 내려받아 숨기기
  - 화면 바깥 부분

#### 내려받아 줄이기

- width와 height를 명시하지 않으면 브라우저의 처리 성능을 저하시킨다.
- 화면의 이미지 크기가 작아진다고 실제 이미지가 작아지지 않기 때문에 브라우저가 큰 이미지를 다운로드해 작게 축소하는 처리가 진행되며 가로 세로 값을 추가로 계산해야 한다.
- 모바일 환경에서는 과도하게 큰 이미지 다운로드와 이미지 축소를 위해 네트워크와 리소스를 낭비한다.

#### 내려받아 숨기기

- 데스크탑 화면에는 모바일 화면에서는 불필요한 리소스들이 존재한다는 의미이다.
- 모바일에는 필요없는 정보들을 숨기기 위해 CSS를 활용해서 숨기기 처리를 해주는 경우가 있다.
  - 브라우저는 HTML에 정의된 리소스들을 그대로 다운로드 한 후에 CSS에 의해 표현할지 결정한다.
  - 따라서 CSS로 숨겨진 이미지도 모두 다운로드해 로딩 시간을 지연시킨다.

#### 화면 바깥 부분

- 화면 바깥 부분의 이미지들은 화면에 보이지 않지만 내려받아 숨기기처럼 모두 다운로드된다.
- 화면 바깥쪽 이미지 다운로드를 위해 긴 시간이 소요되면 전체 페이지의 로딩 시간이 늦어지며 화면 안쪽 부분의 로딩 시간에도 영향을 준다.

### 4.4.3 반응형 이미지

- 위 내용과 같은 문제들을 해결하기 위해서는 사용자의 환경에 적합한 이미지를 전송해야 한다.
- 반응형 이미지란 사용자 환경에 맞게 변경된 이미지를 의미한다.

### 4.4.4 반응형 이미지 구현 방법

- 반응형 이미지 구현은 프론트엔드와 백엔드 측면에서 구현될 수 있다.
  - 프론트엔드: 미디어 쿼리를 사용해 클라이언트 환경을 파악한 후 그 환경에 맞는 이미지 파일을 호출하도록 웹 페이지를 구현할 수 있다.
  - 백엔드: 서버에서 클라이언트 환경에 맞는 이미지를 선택해 전송할 수 있다.

#### srcset과 size 속성

```html
<img
  src="small.jpg"
  alt="rwd"
  srcset="pic-200.jpg 200w, pic-400.jpg 400w"
  size="(mac-width: 400px) 100vw, (max-width: 800px) 30vw, 300px"
/>
```

- srcset은 img 태그 속성으로 사용자의 다양한 환경에 따라 다른 이미지 URL을 지정할 수 있도록 한다.
- size 속성은 브레이크 포인트에 따른 이미지 크기를 지정할 수 있다.
- srcset은 브라우저에 가장 적절한 이미지를 선택하도록 힌트를 주는 역할을 하며 내려받아 줄이기 문제를 어느 정도 해결할 수 있다.

#### picture 태그

```html
<picture>
  <source media="(min-width: 45em)" srcset="large.jpg, large-hd.jpg 2x" />
  <source media="(min-width: 18em)" srcset="med.jpg, med-hd.jpg 2x" />
  <source src="small-1.jpg" alt="rwd" />
</picture>
```

- picture 태그는 img srcset의 단점을 모두 보완한다.
- 내부적으로 source 태그를 사용해 다양한 이미지 URL을 설정하게 한다.
- 미디어 쿼리를 사용해 URL의 로딩 조건을 구체적으로 정의할 수 있다.
- srcset과는 다르게 정의된 조건에 맞는 이미지만 사용하도록 브라우저를 강제할 수 있으면 조건에 맞지 않는 이미지는 다운로드하지 않는다.
- 내려받아 숨기기와 내려받아 줄이기 문제를 모두 해결하는 가장 효과적인 방법이지만 IE와 구버전 브라우저들에서 지원되지 않는다.

#### Art direction

- srcset과 picture의 반응형 이미지가 사용자 환경에 따라 자동으로 변하지 않는 문제를 해결하기 위한 방법이다.
- 같은 이미지를 크기만 다르게 하는 것이 아니라 이미지의 특징이나 가치가 기기 특성에 따라 표현되도록 정교한 작업을 진행하는 것이다.
- 개발 및 운영에 많은 시간과 비용이 요구된다는 단점이 있다.

#### Client Hints

- picture 태그, srcset 속성과는 전혀 다른 접근법을 제공한다.
- 웹 페이지를 호스팅하는 서버에서 사용자 환경을 고려해 응답할 내용을 최적화한 후 브라우저에 전달하는 방안이 도입되고 있다.
- 이때 사용자 환경을 서버에 표준 방식으로 전달하기 위해 Client Hints를 사용하도록 논의되고 있다.
- Client Hints 헤더는 HTTP 헤더의 일부로 포함되며 이 정보를 기반으로 응답 내용을 최적화 해 다시 브라우저에 전송할 수 있다.

#### 이미지 지연 로딩

- 사용자들에게 노출될 수 있는 상태일때 실제 이미지 정보를 링크시켜 다운로드하게 한다.

#### 모바일 우선 접근

- 모바일 기기에 적합한 페이지부터 개발하는 방법이다.

## 4.5 적응형 이미지 전략

- 반응형 웹은 파일 사이즈가 커지고 다양한 변수를 고려해야 하는 문제점이 있다.
- 모바일 기기는 네트워크 속도는 데스크톱에 비해 느리므로 데스크톱과 똑같이 그대로 내려받는 것은 매우 비효율적이다.
- 이를 해결하고자 서버측 반응형 웹 접근 방법이 등장했다.

### 4.5.1 적응형 이미지 아키텍처

- 적응형 이미지 아키텍처에서는 "요청 클라이언트 정보를 어떻게 감지할 것인가"가 중요하다.
  - HTTP 요청의 User-Agent 헤더를 통해 브라우저, 시스템, 사용자 정보 등을 알 수 있다.
  - 다양한 검출 솔루션을 통해 뷰포트, 스크린 크기, 화소 밀도 등의 정보를 알 수 있다.
- 또한 클라이언트 맞춤형 데이터를 로딩하는 서버 로직이 추가되어야 한다.

### 4.5.2 기기 정보에 따라 서버 로직 수행

- 관련 정보를 수집했다면 클라이언트 환경에 맞는 이미지 파일을 링크에 연결한다.
  1. 브레이크 포인트를 사전에 정의한다.
  2. 검출된 기기의 너비를 추출한다.
  3. 추출한 너비가 특정 브레이크 포인트보다 작으면 그 포인트에 해당하는 이미지를 로드 시킨다.
- 웹 사이트 성격에 따라 적절한 이미지를 선택하는 정책과 서버 로직을 만들어야 한다.

### 4.5.3 브라우저별 이미지 전달

```
accept: image/webp,image/apng,image/*,*/*;q=0.8
```

- 브라우저별 이미지는 HTTP 요청의 Accept 헤더를 참고해 결정할 수 있다.

### 4.5.4 캐시 고려 사항

- 서버 측 반응형 웹이나 이에 따른 적응형 이미지를 구성할 때 성능을 고려해 이미지를 캐시하는 경우가 많다.
- 적응형 이미지는 동일한 URL을 사용해도 사용자 기기에 따라 다른 이미지가 응답될 수 있다. 이것은 캐시 충돌 현상의 원인이 된다.
  - 캐시 충돌 현상: 하나의 URL에 여러 개의 다른 콘텐츠가 응답할 수 있을 때 먼저 응답하는 콘텐츠만 캐시되는 현상이다.
- 캐시 충돌 현상을 피하려면 서버에서 응답할 때 Vary 헤더를 활용해서 특정 헤더에 따라 콘텐츠가 달라질 것이라고 캐시 서버에 알려줘야한다
