# 2장. 웹최적화

- 웹 사이트는 검색 엔진 최적화를 실행하면 빠르게 검색된다.
- SEO가 적용된 웹 사이트는 다른 사이트에 비해 상단 노출 회수가 높으며 많은 방문자를 이끌어낼 수 있다.

## 2.1. 웹 최적화란

### 2.1.1. 프론트엔드 최적화

- 웹 UI/UX와 관련된 최적화이다.
- 최적화가 잘 되어 있는 웹사이트는 브라우저에서 콘텐츠를 다운로드, 로딩, 렌더링할 때 속도가 빠르다
- 콘텐츠를 만들어낼 때 최적화를 진행한다.
- 프론트엔드 최적화 기술은 사용자 환경에 따라 달라지기 때문에 상대적으로 적용해야한다.

- 프론트엔드 최적화하는 대표적인 기술은 다음과 같다.
  - 스크립트를 병합(merge)하여 브라우저의 호출 개수를 줄인다.
  - 스크립트 크기를 최소화해 바이트 자체를 줄인다.
  - 스크립트를 gzip 등으로 압축하여 전달
  - WebP 등으로 브라우저 이미지 형식을 최적화
  - 이미지 손실, 무손실 압축
  - cache-control 응답 헤더를 통해 브라우저 캐시를 충실히 사용
  - 도메인 수를 줄여 DNS조회를 최소화한다.
  - DNS 정보 미리 읽어 오기
  - CSS를 HTML 상단에, 자바스크립트를 HTML의 하단에 위치시키기
  - 페이지 미리 읽어 오기
  - 타사 스크립트가 웹 성능을 방해하지 않도록 조정함

### 2.1.2. 백엔드 최적화

- 웹 UI를 로직에 맞게 만드는 최적화.
- 웹 서버, 웹 애플리케이션 서버, 데이터베이스, 로드 밸런싱, DNS 서버 등이 해당된다.
- 프론트엔드 최적화에 비해 가시적인 효과가 크지 않지만, 웹 사이트의 빠른 로딩보다 네트ㅋ워크를 정상적으로 사용하고 콘텐츠를 전달하기 위해 반드시 필요한 요소이다.

- 백엔드를 최적화하는 대표적인 기술은 다음과 같다.

- DNS 응답이 빨라지도록 서버 증설
- DNS 응답을 빠르게 할 수 있도록 DNS 정보를 최대한 캐싱
- 웹 서버가 있는 데이터 센터의 네트워크 출력(throughput)/대역폭(bandwidth) 증설
- 웹 서버, 웹 애플리케이션 서버의 CPU/RAM 증설
- 프록시 서버를 설정하여 웹 콘텐츠를 캐싱
- CDN(Content Delivery Network)을 사용해 인터넷상에 콘텐츠 캐싱
- 데이터베이스 정규화로 디스크 I/O 최적화
- 데이터베이스 캐싱으로 응답을 빠르게
- 로드 밸런싱을 통해 가장 성능이 좋은 웹 서버로 요청을 연결
- 웹 애플리케이션 로직을 가볍고 빠르게 개발

### 2.1.3. 프로토콜 최적화

- 웹 콘텐츠를 더 빠르게 요청하고 응답하도록 프로토콜을 업그레이드 하는 과정
- 웹 콘텐츠를 전달하는 HTTP/HTTPS 프로토콜 자체의 효과를 극대화하면 웹 서버가 클라이언트에게 콘텐츠를 최대 속도와 최저 지연 시간으로 전달할 수 있다.

## 2.2 TCP/IP 프로토콜

- 웹은 TCP/IP 프로토콜(4, 전송)의 일종인 HTTP(7, 응용)를 사용해 콘텐츠를 전달한다.
- 전송 계층: 네트워크상에서 송신자와 수신자 사이에 데이터 전송을 보장하는 역할
- 응용 계층: 메일, FTP, 인터넷 등 실제 네트워크상에서 SW와 사용자의 상호 연동을 담당한다.
- 전송계층과 응용계층은 독립적인 것이 아니라 상위 계층인 응용 계층이 하위 계층인 전송 계층을 바탕으로 운용되는 구조다.

TCP 네트워크의 대표적인 성능 지표

- 대역폭: 특정 시간동안 얼마나 많은 네트워크 트래픽을 보낼 수 있는지. 시간당 전송량이다.
- 지연 시간: 클라이언트와 서버 사이의 요청 + 전달 + 응답시간을 의미한다.

TCP는 웹 성능과 밀접한 관련이 있다.

### 2.2.1 TCP 혼잡제어

- TCP 혼잡 제어(congestion control): TCP 네트워크의 통신량을 조절하여 TCP 네트워크가 혼잡해지지 않도록 하는 방식이다.
- TCP 혼잡 붕괴(congestion collapse): TCP 네트워크의 통신량이 실제 처리량보다 많아서 문제가 발생하는 것이다.
  - 인터넷에 연결된 호스트들이 최대한 많은 정보를 전송하려고 많은 네트워크 패킷을 보내기 때문에 발생한다.
- TCP 혼잡 제어 기술: 패킷을 보내는 쪽에서 네트워크에서 수용할 수 있는 양을 파악해 그만큼의 패킷만 보내는 약속으로 해결한다.
- 받는 쪽은 패킷이 정상적으로 송신되었음을 알리는 ACK 패킷을 보내며, ACK 패킷을 받은 호스트는 지속적으로 패킷을 보낼 수 있다.
- 호스트가 네트워크의 상태를 파악하고 전송 속도를 조절하는 것 또한 혼잡 제어 기능 중 하나다.

#### 느린시작

- 느린 시작(slow start): TCP 연결이 시작되면 전송 가능한 버퍼의 양인 혼잡 윈도우의 초깃값을 작게 설정하여 전송한다.
- 패킷이 도착할 때마다 더 많은 패킷을 보내고, 이를 패킷 유실(packet drop)이 발생하기 전까지 반복하는 방식이다.
- 호스트가 ACK 응답을 받지 못하면 혼잡 윈도우의 크기는 더이상 늘어나지 않음.
- HTTP에서도 사용되며 웹 사이트에 접속한 브라우저는 처음부터 많은 패킷을 보내지 않음.

#### 빠른 재전송

- 빠른 재전송(fast retransmit): 먼저 도착해야 하는 패킷이 도착하지 않고 다음 패킷이 도착한 경우에도 수신자가 일단 ACK 패킷을 보내는 방식.
- 중간에 패킷이 하나 손실되면 송신자는 중복된 ACK 패킷을 통해 이를 감지하고 정상적으로 전송되지 않은 패킷을 재전송.
- 중복된 패킷을 3개 받으면 반드시 손실된 패킷을 재전송.
- 동시에 혼잡 제어가 필요한 상황임을 인식해 혼잡 윈도우 창 크기를 줄이는 작업도 실행.

#### 흐름제어

- TCP 송신자가 데이터를 너무 빠르게 혹은 너무 많이 전송하여 수신자의 버퍼가 오버플로되는 현상을 방지
- 상위 계층으로 세그먼트를 보내는 애플리케이션 프로세스에서 데이터를 읽는 속도가 느려질 수 있음.
- 트래픽 수신 속도를 송신 속도와 일치시키는 기술.

## 2.3. HTTP 프로토콜

- HTTP 성능을 향상하면 웹 성능도 향상된다.

#### HTTP 최적화 기술

- HTTP 프로토콜 업데이트는 주로 웹 환경 변화에 밀접하게 대응하는 기능을 추가한 것.
- HTTP/0.9 버전까지 클라이언트와 서버의 인터넷 통신 정상화, 가용성 신뢰성 등에 초점.
- HTTP/1.0 버전부터는 클라이언트와 서버 사이 요청과 응답을 빠르게 할 수 있는 연구 진행.
  HTTP/1.0 버전까지는 단순 CS(Client Server)환경에서 사용할 수 있는 충분한 기능이 포함.

#### HTTP 지속적 연결

- Keep-Alive 혹은 연결 재사용이라고도 불린다.
- HTTP 지속적 연결은 클라이언트와 서버가 TCP 상에서 한 번 연결되면 둘 사이의 연결이 완전히 끊어지기 전 까지 맺어진 연결을 지속적으로 재사용하는 기술

#### HTTP 파이프라이닝

- HTTP 선입 선출(FIFO) 방식의 단점을 극복하는 데서 출발.
- 기존에는 HTTP 요청과 응답이 여럿일 때 하나의 응답이 지연되면 나머지 요청과 응답이 모두 지연될 수 밖에 없는 구조.
- HTTP 파이프라이닝은 먼저 보낸 요청의 응답이 없어도 다음 요청을 병렬적으로 수신자 측에 전송하는 기술.
- 중간에서 응답 지연이 발생하더라도 클라이언트는 먼저 서버 측의 응답을 받을 수 있어 전체적으로 빠른 웹 로딩이 구현되는 구조.

## 2.4. DNS

- DNS란 인터넷 호스트명을 클라이언트와 서버가 이애할 수 있는 IP 주소로 변환해주는 시스템
- DNS 질의와 응답 성능이 나쁘면 웹 사이트 로딩에 영향을 줄 수 있다.

### 2.4.1 DNS의 작동 원리

![dns](./asset/99C16C455BDFBB2A23.png)

1. 웹 브라우저에 www.naver.com을 입력하면 먼저 Local DNS에게 "www.naver.com"이라는 hostname"에 대한 IP 주소를 질의하여 Local DNS에 없으면 다른 DNS name 서버 정보를 받음(Root DNS 정보 전달 받음)
2. Root DNS 서버에 "www.naver.com" 질의
3. Root DNS 서버로 부터 "com 도메인"을 관리하는 TLD (Top-Level Domain) 이름 서버 정보 전달 받음
4. TLD에 "www.naver.com" 질의
5. TLD에서 "name.com" 관리하는 DNS 정보 전달
6. "naver.com" 도메인을 관리하는 DNS 서버에 "www.naver.com" 호스트네임에 대한 IP 주소 질의
7. Local DNS 서버에게 "응! www.naver.com에 대한 IP 주소는 222.122.195.6 응답
8. Local DNS는 www.naver.com에 대한 IP 주소를 캐싱을 하고 IP 주소 정보 전달

### 2.4.2. 사용중인 다양한 도메인 확인 방법

- 웹 사이트는 자신의 웹 서비스 콘텐츠뿐만 아니라 다른 웹 서비스의 다양한 콘텐츠를 호출하여 사용
- 크롬에서 `도구더보기 -> 개발자 도구 -> Source` 를 통해 하나의 웹페이지에 어떤 도메인이 사용되고 있는지 파악
- 타사 서비스 도메인 조회 속도가 웹페이지 로딩속도에 영향을 끼칠 수 있기 때문에 지속적으로 모니터링하고 해결해야 함

### 2.4.3. 웹 성능을 최적화 하는 도메인 운용 방법

- 많은 도메인 호스트명을 사용하면 DNS 질의가 늘어나 응답시간이 길어지고 웹 성능에 영향을 줌
- 상위 도메인을 동일하게 해 DNS 질의를 최대한 적게 만드는 것을 권장
- 공통된 상위 도메인을 사용하는 서비스들은 도메인 질의를 담당하는 네임 서버에 캐싱된 정보를 재사용할 수 있어 DNS 질의 시간을 단축.
- HTML의 DNS Prefetch 기능을 사용하면 웹페이지에 사용된 도메인들의 DNS를 조회하는 시간을 더 빠르게 가져갈 수 있음

## 2.5 브라우저
