# 9장. 웹 최적화 트렌드

## 9.1 웹 최적화의 역사

- 웹 성능 최저화는 주로 서버 용량 증설이나 웹 서버 등 소프트웨어 성능 개선에 집중되었다.
- HTTP/1.1에는 웹 성능 최적화를 위한 여러 기능들이 추가되었다.
- 연결 효율화를 위한 Keep-Alive, 데이터 분할 전송을 위한 Chunked encoding, byte-range 기능 그리고 브라우저 캐시를 위한 메커니즘 등이 추가되었다.

### 9.1.1 모바일 기기의 등장과 모바일 사이트 최적화

- 스마트폰 사용자가 증가하여 웹 사이트의 많은 것들이 바뀌었다.
- 모바일과 데스크탑의 사이트 경험을 동일하게 만들기 위해 반응형 웹 기술이 적용되었다.
- 데스크톱에서 필요한 이미지를 모바일에서도 다운받아야 하기때문에 로딩이 느려지는 문제가 발생했다.
- 이를 해결하기 위해 `미디어쿼리`, `<picture>`태그, `srcset` 속성 등을 이용해 디바이스에 맞는 리소스들을 다운로드 하도록 했다.
- SPA 관련 기술로 모바일에 필요한 리소스만 다운받으면 되므로 전송 리소스는 크기가 작아지고 렌더링 속도는 빨라진다.
- 그러나 브라우저에서 수행되는 자바스크립트들이 무거워져 초기 다운로드와 구동 시 시간이 오래걸릴수 있는 단점이 있다.
- 서버측에서 접속자의 환경을 미리 파악해 최적화된 리소스를 만들어주는 방법이 있다.
- 아직 접속 기기의 정보를 정확하게 파악하기 어려운 단점이 있다.

## 9.2 PWA

- 브라우저에서는 URL만 클릭하면 웹 사이트에 접속할 수 있어 애플리케이션을 검색하고 설치하는 것보다 빠르고 쉽게 접근할 수 있다.
- PWA는 이러한 네이티브 앱과 모바일 웹의 장점을 모두 갖추도록 특정 기술과 표준 패턴을 사용해 개발한 웹 앱이다.
- PWA는 브라우저를 통해 구동되므로 사용자가 접근하기에 유용하며, 별도의 설치가 필요없다.
- PWA는 다음과 같은 특징을 지녀야 한다.

  - 모든 형태의 화면에 반응해야한다.
  - 네트워크 독립적이어야 한다. 서비스 워커를 통해 주요 리소스를 캐시해 오프라인에서도 제공할 수 있어야한다.
  - 앱과 같은 상호작용 기능이 있어야한다.
  - 항상 최신 내용으로 업데이트되어 있어야 한다.
  - 웹이나 앱의 모든 연결은 보안상 안전해야 한다.
  - 아무리 훌륭한 웹 앱이라도 사용자들이 알지 못하면 무용지물이다.
  - 재참여할 수 있어야 한다.
  - 설치할 수 있어야한다.
  - 쉽게 연결할 수 있어야한다.

- 다음은 PWA를 사용할 때의 몇가지 이점이다.
  - 서비스 워커를 사용한 캐시로 앱 로딩 시간을 줄이고 데이터를 경제적으로 사용할 수 있다. 심지어 오프라인에서도 사용가능하다.
  - 앱 업데이트 시 변경된 콘텐츠만 업데이트 가능하다.
  - 플랫폼과 상관없이 반응형으로 동작하므로 다양한 플랫폼에서 사용가능하다.
  - 푸쉬 알림을 통해 사용자의 재참여를 이끌어내고 이를 통해 구매전환율 같은 비즈니스 지표를 개선할 수 있다.

### 9.2.1 PWA 주요 기술

### PWA 애플리케이션 아키텍쳐

- PWA는 크게 애플리케이션 셸과 콘텐츠로 구성된 아키텍쳐이다.
- 애플리케이션 셸은 응용 프로그램의 인프라를 설명하는 개념이다.
- 동작하는데 필요한 모든 정적파일로 구성되며 웹 개발과 관련된 모든 파일이 애플리케이션 셸에 포함된다.
- 앱을 처음 로딩할 때 애플리케이션 셸을 캐시해야 오프라인에서도 동작한다.
- 오프라인 로딩은 서비스워커를 통해 수행된다.
- 서비스 워커가 오프라인을 대비해 정적 리소스를 캐시할 수 있지만, 웹 사이트를 최초 로딩할 때 서비스 워커 스크립트를 비롯한 다른 정적파일을 다운로드 받아야하기 때문에 이를 최소화 하려면 지금까지 살펴보았던 파일크기 줄이기, 네트워크 요청수 줄이기, 렌더링 가속화 등 최적화 방법을 고려해 개발해야 한다.

### 애플리케이션 메니페스트 파일

- 메니페스트 파일은 앱의 정보를 담고있는 JSON 기반 파일이다.
- 홈 화면에 앱 아이콘, 앱 로딩될 때 첫 페이지, 표시방향 등 구동 정보를 설정하기 위해 필요하다.
- 그리고 브라우저가 매니페스트 파일을 찾기 쉽도록 모든 웹페이지에 파일 링크를 설정해두는것을 권장한다.

> <link rel="manifest" href="/manifest.json">

### 서비스 워커

- 서비스 워커는 오프라인에서 PWA를 구동할 수 있도록 하는 자바스크립트 형태의 핵심 기술이다.
- 브라우저와 독립적으로 실행되며 다양한 요청을 비동기적으로 처리한다.
- 일종의 프록시 처럼 동작하며 네트워크 관련 요청을 가로채기도 한다.
- 리소스를 캐싱하거나 검색하고 필요에 따라 푸쉬알림을 전달할 수 있다.
- PWA는 인터넷에 연결되어 있지 않아도 캐싱된 데이터를 표시하고 네트워크에 연결되어있지 않다고 표시할 수 있다.
- 서비스 워커는 DOM에 직접 액세스 할 수 없다.
- 서비스 워커도 자바스크립트이기 때문에 브라우저 렌더링에 영향을 줄 수 있다.
- 따라서 등록 시점을 잘 결정해 등록하는것을 권한다.

### 9.2.2 PWA 사례

### 스타벅스

### MakeMyTrip

### Pinterest

## 9.3 AMP(Accelerated Mobile Pages)

- AMP는 이미 성능 최적화가 된 웹 컴포넌트를 제공한다.
- 개발자가 복잡하고 어려운 최적화 기법을 신경쓰지 않고 사이트 개발에만 집중할 수 있도록 도와주는 프레임워크이다.
- 이론상 AMP에서 제시하는 방법대로 개발하면 4배정도 최적화된다.

### 9.3.1 AMP의 특징

- 콘텐츠 렌더링을 방해하지 않는다.
  - AMP는 모든 자바스크립트들을 비동기적으로 로딩시키고 처리함으로써 주요 콘텐츠들의 렌더링을 방해하지 않는다.
- 레이아웃을 미리 결정하여 리플로우를 방지한다.
  - AMP는 이미지나 iframe 등 정적 리소스들의 크기를 필수 지정하도록 하여 모두 다운로드 하기 전에 브라우저는 미리 필요한 레이아웃을 만들어놓을 수있어 리플로우를 방지할 수 있다.
- 경량화된 CSS를 HTML 내부에 작성하여 렌더링을 빠르게 시작한다.
  - 불필요한 스타일 룰들이 추가되는것을 방지한다.
- 웹 폰트를 최적화한다.
  - 폰트 다운로드를 방해할만한 HTTP 요청 없이 필요한 폰트들을 빠르게 다운로드 할 수 있다.
- 스타일과 화면 재배치를 최소화한다.
  - AMP는 화면 재배치 작업을 최대한 효율적으로 관리하는 기능을 제공한다. 화면 재배치와 같은 고성능 작업을 최소화하기 위해 지능적으로 모든 읽기와 변경을 통합한다. 실제로 AMP는 페이지가 로딩을 완료하기까지 1회에서 2회정도의 화면 재배치만을 수행한다.
- GPU 가속으로 CPU 사용을 효율화한다.
  - AMP는 고성능 그래픽 처리작업을 GPU에 넘겨 분산 처리하게 하고 CPU가 처리해아할 작업들을 줄여줌으로써 페이지를 더 빠르게 로딩시킨다.
- 중요한 리소스부터 로딩시킨다.
  - AMP는 가장 중요한 리소스부터 다운로드하도록 설계되어 있다.

### 9.3.2 AMP의 구성 요소

- AMP Websites, AMP Stories, AMP Ads, AMP Email

### AMP HTML

- AMP Websites, AMP Stories, AMP Ads, 모듈들은 AMP HTML 명세에 의해 만들어진다.
- AMP HTML은 HTML5를 기반으로 하기때문에 구동ㄹ하는데 별도의 엔진이 필요하지 않다.
- 마크업 규칙
  - <!doctype html>로 시작해야한다.
  - 최상위 레벨 태그로 <html ⚡> 또는 <html amp>를 사용한다.
  - <head> 와<body>태그가 존재해야 한다.
  - <link rel="canonical" href="$SOME_URL">을 사용해 서로의 페이지를 링크시킨다.
  - 페이지 인코딩을 위해 <meta charset="utf-8">이 첫번째 태그로 와야한다.

### 9.3.3 AMP와 반응형 웹 디자인

- `layout`이라는 속성값을 사용하면 반응형 웹을 디자인 할 수 있다.
- 필요한 미디어쿼리나 srcset등 모두 지원되므로 화면의 브레이크 포인트에 맞는 웹페이지를 구성할 수 있다.

## 9.4 웹 최적화의 실상과 과제

- 모바일 기술의 발전에도 웹사이트의 로딩속도는 크게 나아지지 않는 실상이다.

### 9.4.1 웹 최적화의 실상

- 모바일 사용자의 비율이 크게 늘었기 떄ㅐ문이다.
- 웹 사이트에 사용되는 이미지 크기는 여전히 증가하고 있다.
- 자바스크립트 라이브러리들이 등장하고 이에따라 스크립트의 크기도 크게 증가하고있다.

### 9.4.2 웹 최적화의 과제
